#include QMK_KEYBOARD_H
#include "voyager.h"
#include "i18n.h"
#include "comboooos.c"

#define MOON_LED_LEVEL LED_LEVEL
#define ML_SAFE_RANGE  SAFE_RANGE

enum custom_keycodes {
    RGB_SLD = ML_SAFE_RANGE,
};
const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
    // clang-format off
    [BASE] = LAYOUT_voyager(
        /*   ---------------------------------------------------------------------------        --------------------------------------------------------------------------- */
        /*   ||   CAPS_WORD |     1     |     2     |     3     |     4     |     5   ||       ||        6    |     7    |     8    |     9     |     0     |   BACKSPACE  | */
        /*   || */ CW_TOGG  ,  KC_1     ,  KC_2     ,  KC_3     ,  KC_4     ,  KC_5    ,              KC_6    ,  KC_7    ,  KC_8    ,  KC_9     ,  KC_0     ,   KC_BSPC,/* |\ */
        /*    --------------------------------------------------------------------------       ||-------------------------------------------------------------------------- */
        /*   ||     ESC     |     Q     |     W     |     E     |     R     |     T   ||       ||       Y    |     U     |     I    |     O    |     P      |     \        | */
        /*   || */KC_ESCAPE ,  KC_Q     ,  KC_W     ,  KC_E     ,  KC_R     ,  KC_T    ,             KC_Y    ,  KC_U     ,  KC_I    ,  KC_O    ,  KC_P      , BR_BSLS  ,/* |\ */
        /*   ---------------------------------------------------------------------------        --------------------------------------------------------------------------- */
        /*   || OSM SHIFT   |     A     |     S     |     D     |     F     |     G   ||       ||       H    |     J     |     K    |     L    |     ;      |     "        | */
        /*   ||*/OSM_LSHIFT ,  KC_A     ,  KC_S     ,  KC_D     ,  KC_F     ,  KC_G    ,             KC_H    ,  KC_J     ,  KC_K    ,  KC_L    , BR_SCLN    , BR_QUOT  ,/* |\ */
        /*   ---------------------------------------------------------------------------       ||-------------------------------------------------------------------------- */
        /*   ||             |     Z     |     X     |     C     |     V     |     B   ||       ||       N    |     M     |     ,    |     .    |     /      |              | */
        /*   || */KC_TRNS   ,  KC_Z     ,  KC_X     ,  KC_C     ,  KC_V     ,  KC_B    ,             KC_N    ,  KC_M     ,KC_COMMA  ,  KC_DOT  ,  BR_SLSH   ,  KC_TRNS ,/* |\  */
        /*   ---------------------------------------------------------------------------       ||-------------------------------------------------------------------------- */
        /*                                                ||    SPC    |      TAB     ||       ||     ENTER      |   SPC        || */
        /*                                                ||*/ KC_SPACE,     KC_TAB   ,            KC_ENTER      ,  KC_SPACE // ||
        /*                                                 -----------------------------       ||-------------------------- */
    )

    // clang-format on
};

uint16_t get_tapping_term(uint16_t keycode, keyrecord_t *record) {
    switch (keycode) {
        case LT(5, KC_W):
            return g_tapping_term + 50;
        case MT(MOD_LGUI, KC_A):
            return g_tapping_term + 50;
        case MT(MOD_LALT, KC_S):
            return g_tapping_term + 50;
        case LT(5, KC_O):
            return g_tapping_term + 50;
        case MT(MOD_LALT, KC_L):
            return g_tapping_term + 50;
        case MT(MOD_RGUI, BR_SCLN):
            return g_tapping_term + 50;
        default:
            return g_tapping_term;
    }
}

extern rgb_config_t rgb_matrix_config;

void keyboard_post_init_user(void) {
    rgb_matrix_enable();
}

const uint8_t PROGMEM ledmap[][RGB_MATRIX_LED_COUNT][3] = {
    [0] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {119, 240, 192}, {72, 240, 198}, {39, 247, 255}, {0, 218, 204}, {157, 218, 204}, {0, 0, 0}, {212, 218, 204}, {212, 218, 204}, {212, 218, 204}, {212, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {157, 218, 204}, {0, 218, 204}, {39, 247, 255}, {72, 240, 198}, {119, 240, 192}, {0, 0, 0}, {0, 0, 0}, {211, 218, 204}, {212, 218, 204}, {212, 218, 204}, {212, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}},

    [1] = {{0, 0, 0}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 0, 255}, {0, 0, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}},

    [2] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 0, 0}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 218, 204}, {0, 0, 0}, {0, 213, 199}, {0, 0, 255}, {0, 0, 255}},

    [3] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {39, 247, 255}, {0, 0, 0}, {0, 0, 0}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {0, 0, 0}, {0, 0, 0}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {0, 0, 0}, {0, 0, 0}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {0, 0, 255}, {0, 0, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {39, 247, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}},

    [4] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {39, 247, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}, {39, 247, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {39, 247, 255}, {0, 0, 0}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {0, 0, 0}, {0, 0, 0}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {0, 0, 0}, {0, 0, 0}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {39, 247, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}},

    [5] = {{0, 0, 0}, {0, 0, 0}, {72, 240, 198}, {72, 240, 198}, {72, 240, 198}, {72, 240, 198}, {0, 0, 0}, {72, 240, 198}, {72, 240, 198}, {72, 240, 198}, {72, 240, 198}, {72, 240, 198}, {0, 0, 0}, {72, 240, 198}, {72, 240, 198}, {72, 240, 198}, {72, 240, 198}, {72, 240, 198}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {72, 240, 198}, {72, 240, 198}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}, {72, 240, 198}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {72, 240, 198}, {72, 240, 198}, {72, 240, 198}, {72, 240, 198}, {0, 0, 0}, {0, 0, 0}, {72, 240, 198}, {72, 240, 198}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}},

    [6] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {119, 240, 192}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}},

    [7] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {157, 218, 204}, {157, 218, 204}, {157, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {157, 218, 204}, {157, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {157, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}},

    [8] = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {157, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {157, 218, 204}, {157, 218, 204}, {157, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {157, 218, 204}, {157, 218, 204}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 255}, {0, 0, 255}},

};

void set_layer_color(int layer) {
    for (int i = 0; i < RGB_MATRIX_LED_COUNT; i++) {
        HSV hsv = {
            .h = pgm_read_byte(&ledmap[layer][i][0]),
            .s = pgm_read_byte(&ledmap[layer][i][1]),
            .v = pgm_read_byte(&ledmap[layer][i][2]),
        };
        if (!hsv.h && !hsv.s && !hsv.v) {
            rgb_matrix_set_color(i, 0, 0, 0);
        } else {
            RGB   rgb = hsv_to_rgb(hsv);
            float f   = (float)rgb_matrix_config.hsv.v / UINT8_MAX;
            rgb_matrix_set_color(i, f * rgb.r, f * rgb.g, f * rgb.b);
        }
    }
}

bool rgb_matrix_indicators_user(void) {
    if (rawhid_state.rgb_control) {
        return false;
    }
    if (keyboard_config.disable_layer_led) {
        return false;
    }
    switch (biton32(layer_state)) {
        case 0:
            set_layer_color(0);
            break;
        case 1:
            set_layer_color(1);
            break;
        case 2:
            set_layer_color(2);
            break;
        case 3:
            set_layer_color(3);
            break;
        case 4:
            set_layer_color(4);
            break;
        case 5:
            set_layer_color(5);
            break;
        case 6:
            set_layer_color(6);
            break;
        case 7:
            set_layer_color(7);
            break;
        case 8:
            set_layer_color(8);
            break;
        default:
            if (rgb_matrix_get_flags() == LED_FLAG_NONE) rgb_matrix_set_color_all(0, 0, 0);
            break;
    }
    return true;
}

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    switch (keycode) {
        case RGB_SLD:
            if (record->event.pressed) {
                rgblight_mode(1);
            }
            return false;
    }
    return true;
}
